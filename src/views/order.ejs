<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Order Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="icon" type="image/x-icon" href="/image/uet.jpeg">
</head>
<body>
    <!-- Header -->
    <header>
        <%- include('partials/header') %>
    </header>

    <!-- Main Content -->
    <div class="container mt-4">
        <h2 class="mb-4">Order Management</h2>

        <% if (!orders || !Array.isArray(orders) || orders.length === 0) { %>
            <div class="alert alert-info text-center">Bạn chưa có đơn hàng nào.</div>
        <% } else { %>
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Status</th>
                        <th>Total</th>
                        <th>Order Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% orders.forEach(order => { %>
                        <tr>
                            <td>#<%= order.id %></td>
                            <td><%= order.full_name %></td>
                            <td>
                                <span class="badge bg-<%= order.status === 'Completed' ? 'warning' : 'success' %>">
                                    Success
                                </span>
                            </td>
                            <td>$<%= order.total_price %></td>
                            <td><%= new Date(order.created_at).toLocaleString() %></td>
                            <td>
                                <a href="/order/<%= order.id %>" class="btn btn-primary btn-sm">View</a>
                                <button class="btn btn-danger btn-sm cancel-order" data-id="<%= order.id %>">Cancel</button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>
    </div>

    <!-- Footer -->
    <footer>
        <%- include('partials/footer') %>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const cancelButtons = document.querySelectorAll(".cancel-order");

            cancelButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const orderId = this.getAttribute("data-id");
                    if (confirm(`Bạn có chắc muốn hủy đơn hàng #${orderId}?`)) {
                        fetch(`/api/orders/cancel/${orderId}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("Đơn hàng đã được hủy.");
                                location.reload();
                            } else {
                                alert("Hủy đơn hàng thất bại. Vui lòng thử lại.");
                            }
                        })
                        .catch(error => console.error("Error:", error));
                    }
                });
            });
        });
    </script>
</body>
</html>
